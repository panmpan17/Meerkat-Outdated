{% extends "base.html" %}
{% block title %}教師廣告{% endblock %}
{% block css %}
<link href="/html/css/datepicker.css" rel="stylesheet">
<style>
	div.mynav-sidebar {
		color: white;
		position: fixed;
		width: 170px;
		background: rgb(6, 48, 68);
		left: 0;
		top: 130px;
	}

	div.mynav-sidebar .item {
		padding: 10px 15px;
		cursor: pointer;
		background: transparent;
	}

	div.mynav-sidebar .item:hover {
		background: white;
		color: rgb(6, 48, 68);
	}

	div.mynav-sidebar .nav-dropdown {
		display: none;
		list-style: none;
		padding-left: 25px;
		margin-bottom: 0;
		max-height: 315px;
		overflow-y: scroll;
	}

	div.mynav-sidebar .nav-dropdown::-webkit-scrollbar {
	    width: 10px;
	}

	/* Handle */
	div.mynav-sidebar .nav-dropdown::-webkit-scrollbar-thumb {
	    background: rgb(9, 72, 102); 
	}

	/* Handle on hover */
	div.mynav-sidebar .nav-dropdown::-webkit-scrollbar-thumb:hover {
	    background: white; 
	}

	div.mynav-sidebar .nav-dropdown li {
		cursor: pointer;
		padding: 5px 8px;
		background: rgb(6, 48, 68);
		color: white;
	}

	div.mynav-sidebar .nav-dropdown li:hover {
		color: rgb(6, 48, 68);
		background: white;
	}

	div.mynav-sidebar #page-control {
		position: fixed;
		top: 60px;
		left: 0px;
		width: 100%;
		max-height: 70px;
		overflow: hidden;
		margin-left: 15px;
		background: rgb(219, 238, 252);
	}

	#cards {margin-left: 190px;}

	#cards .card {
		float: left;
		display: inline-block;
		background: rgb(240, 240, 240);
		min-width: 250px;
		width: 20%;
		margin: 4px 4px;
	}

	#cards .card img {
		width: 100px;
		float: left;
	}

	#cards .card .info {
		float: left;
		margin-top: 20px;
		line-height: 30px;
	}

	#cards .card .info #name {
		font-size: 20px;
		font-weight: 900;
	}

	#cards .card .info #contact {
		font-size: 13px;
		font-weight: 100;
		color: #AAA;
	}

	#cards .card .describe {
		clear: left;
		padding: 0px 15px;
	}

	#cards .card .bttn {
		background: rgb(6, 48, 68);
		color: white;
		clear: left;
		float: right;
		width: 60px;
		height: 25px;
		line-height: 25px;
		text-align: center;
		cursor: pointer;
	}

	#cards .card .bttn:hover {
		background: white;
		color: rgb(6, 48, 68);
	}
</style>
{% endblock %}
{% block content %}
	<br><br>
	<div class="mynav-sidebar">
		<div id="cities-btn" class="item" onclick="toggle('cities');hide('towns')"> 縣市</div>
		<ul id="cities" class="nav-dropdown"></ul>
		<div id="towns-btn" class="item" onclick="toggle('towns');hide('cities')"> 鄉鎮區</div>
		<ul id="towns" class="nav-dropdown"></ul>
	</div>
{% endblock %}
{% block bcontent %}
<div id="adclass-frame" class="loginsignup-frame" hidden>
	<div class="loginsignup-frame-inside">
		<a id="closeloginframe" onclick="hide('adclass-frame');" style="">X</a>
		<br>
		<div class="frame-content" style="padding: 15px;padding-top: 0%;">
			<center id="adclasses" >
			</center>
		</div>
	</div>
</div>
<div id="cards"></div>
{% endblock %}
{% block script %}
	<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
	<script src="/html/javascript/datepicker.js"></script>
	<script src="/html/javascript/taiwan_town.js"></script>
	<script>
		month_re = new RegExp("[0-9]+ 月")
		CLASS_TO = {
			"python_01": "Python 初級",
			"scratch_1": "Scratch 初級",
			"hourofcode": "Hour of Code",
			"teacher_1": "教師訓練",
		}

		chinese_weekday = [
			"",
			"星期一",
			"星期二",
			"星期三",
			"星期四",
			"星期五",
			"星期六",
			"星期日",
		]

		CARD_F = `<div class="card">
			<img src="http://www.iconninja.com/files/373/611/612/person-user-profile-male-man-avatar-account-icon.svg" >
			<div class="info">
				<span id="name">{0}</span><br>
				<span id="contact">{1}</span>
			</div>
			<br>
			<div class="describe">{2}</div>
			<div class="bttn">更多</div>
		</div>`

		cities_teachers = {}
		teachers_data = {}

		function change_city (city, city_index) {
			$("#cities-btn")[0].innerHTML = "縣市 - " + city
			$("#cities").hide()
			if (cities_teachers[city_index] == undefined) {
				$.ajax({
					url: host + "adarea/",
					method: "GET",
					data: {"city": city_index},
					success: function (msg) {
						cities_teachers[city_index] = {}

						$.each(msg, function (_, teacher) {
							if (cities_teachers[city_index][teacher["town"]] == undefined) {
								cities_teachers[city_index][teacher["town"]] = new Set()
							}
							cities_teachers[city_index][teacher["town"]].add(teacher["id"])

							t_id = teacher["id"]
							if (teachers_data[t_id] == undefined) {
								teachers_data[t_id] = {
									"id": teacher["id"],
									"name": teacher["name"],
									"phone": teacher["phone"],
									"summary": teacher["summary"],
									"adclass": {}
								}
							}

							adcls_id = teacher["adclassid"]
							if (adcls_id != null) {
								if (teachers_data[t_id]["adclass"][adcls_id] == undefined) {
									teachers_data[t_id]["adclass"][adcls_id] = {
										"id": teacher["id"],
										"type": teacher["type"],
										"address": teacher["address"],
										"date": teacher["date"],
										"enddate": teacher["enddate"],
										"start_time": teacher["start_time"],
										"end_time": teacher["end_time"],
										"weekday": teacher["weekday"],
									}
								}
							}
						})
						display_towns_btn(city, city_index);
						display_teacher(city_index, -1);
					}
				})
			}
			else {
				display_towns_btn(city, city_index);
				display_teacher(city_index, -1);
			}
		}

		function change_town (city_index, town_index, town) {
			$("#towns-btn")[0].innerHTML = "鄉鎮區 - " + town
			$("#towns").hide()

			display_teacher(city_index, town_index)

		}

		function display_towns_btn (city, city_index) {
			$("#towns-btn")[0].innerHTML = "鄉鎮區 - 全部"

			if (Object.keys(cities_teachers[city_index]).length == 0) {
				$("#towns")[0].innerHTML = "";
				alert("這縣市並沒有老師");
				return;
			}

			html = "";

			$.each(Object.keys(cities_teachers[city_index]), function (_, town_index) {
				html += format(
					`<li onclick="change_town('{1}', {2}, '{0}')">{0}</li>`,
					city_towns[city][town_index],
					city_index,
					town_index,
					)
			})
			$("#towns")[0].innerHTML = html;
			$("#towns").show()
		}

		function display_teacher (city_index, town_index) {
			teachers_ids = new Set()
			if (town_index == -1) {
				$.each(cities_teachers[city_index], function (_, teacher_set) {
					teachers_ids = new Set([...teachers_ids, ...teacher_set])
				})
			}
			else {
				teachers_ids = cities_teachers[city_index][town_index]
			}

			html = ""
			$.each(Array.from(teachers_ids), function (_, t_id) {
				t_data = teachers_data[t_id]
				html += format(
					CARD_F,
					t_data["name"],
					t_data["phone"],
					t_data["summary"],
					)
			})

			$("#cards")[0].innerHTML = html
		}

		$(document).ready(function () {
			html = ""
			$.each(cities, function (i, city) {
				html += format(
					`<li onclick="change_city('{0}', {1})">{0}</li>`,
					city,
					i,
					)
			})

			$("#cities")[0].innerHTML = html;
			change_city(cities[0], 0);
		})
	</script>
{% endblock %}