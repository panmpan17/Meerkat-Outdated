{% extends "base.html" %}
{% block title %}教師廣告{% endblock %}
{% block css %}
<style>
	#advertisetable {
		width: 100%;
	}

	#advertisetable td,
	#advertisetable th {
		border: 1px solid #dddddd;
		text-align: left;
		padding: 8px;
		font-size: 18px;
	}

	#advertisetable thead tr {
		background-color: white;
	}


	#advertisetable tbody tr:nth-child(even) {
		background-color: #a9e8e7;
		/*color: white;*/
	}
	#advertisetable tbody tr:nth-child(odd) {
		background-color: #8fdeef;
		/*color: white;*/
	}


	#advertisetable tbody tr:hover:nth-child(even) {
		background-color: #358db2;
		cursor: pointer;
	}

	#advertisetable tbody tr:hover:nth-child(odd) {
		background-color: #0f90c4;
		cursor: pointer;
	}

	td {font-family: Courier;}

	.ui-state-default {
		font-size: 24px;
	}

	.top-bar {
		display: flex;
		width: 90%;
		line-height: 20px;
		top: 0;
		background: #2181bc;
		border-radius: 10px;
		padding: 6px;
	}

	.open {
		z-index: 2;
		cursor: pointer;
		flex: 1;
		position: relative;
		color: #eee;
		font-size: 20px;
		text-align: left;
	}

	.open table td {
		 text-align: left;
	}

	.open #type {
		color: #eeff55;
		font-size:24px;
		position: static;
	}

	.open #start {
		color: white;
		font-size:12px;
	}

	.open #detail {
		text-align: right;
		font-size: 13px;
	}

	.open table td {
		font-size: 16px;
		line-height: 22px;
		color: #144ee2;
		font-weight: 700;
	}

	.open input {
		display: none;
	}

	.open ul {
		display : inline-block;
		width: 100%;
		margin-top: 5px;
		margin-bottom: -5px;
	}

	.open ul li {
		display : inline-block;
		width: 48%;
		height: 35px;
	}

	.open ul li:before {
		content: "○ ";
	}

	.fix-content {
		height: 0px;
	}

	.open .content {
		z-index: 2;
		display: block;
		position: absolute;
		width: calc(100% + 13.5px);
		left: -6px;
		background-color: #89d2ff;
		padding: 15px;
		box-sizing: border-box;
		border-bottom-left-radius: 10px;
		border-bottom-right-radius: 10px;
	}

	.open.slide-down .content {
		opacity: 0;
		transform: translate3d(0, -100%, 0);
		transition: transform 0.5s, opacity 0.5s;
	}

	.open.slide-down input:checked ~ .content {
		transform: translate3d(0, 0, 0);
		opacity: 1;
	}

	.open.pop-in .content {
		opacity: 0;
		transform-origin: center top;
		transform: scale3d(0, 0, 0);
		transition: transform 0.5s, opacity 0.5s;
	}

	.open.pop-in input:checked ~ .content {
		transform: scale3d(1, 1, 1);
		opacity: 1;
	}

	.open.flip-down {
		perspective-origin: center, top;
		perspective: 400px;
	}

	.open.flip-down .content {
		opacity: 0;
		transform-origin: top center;
		transform: rotate3d(1, 0, 0, 90deg) translate3d(0, 10%, 0);
		transition: transform 0.5s, opacity 0.5s;
	}

	.open.flip-down input:checked ~ .content {
		transform: rotate3d(1, 0, 0, 0deg);
		opacity: 1;
	}

	.open.flip-down.flip-back .content {
		transform: rotate3d(1, 0, 0, -90deg) translate3d(0, 10%, 0);
	}
</style>
<link href="/html/css/datepicker.css" rel="stylesheet">
{% endblock %}
{% block content %}
	<br><br><br>
	
	<div class="container">
		<div class="row">
			<div class="col-lg-2 col-md-1 col-sm-12"></div>
			<div class="col-lg-4 col-md-5 col-sm-6">
				<select class="form-control" id="city" onchange="changecity(true)">
					<option value="" selected>全臺</option>
				</select>
				<br>
				<select id="towns" class="form-control">
				</select>
				<br>
			</div>
			<div class="col-lg-4 col-md-5 col-sm-6">
				<select id="classtype" class="form-control">
					<option value="" selected>所有的課程</option>
				</select>
				<br>
				<div class="date-picker" style="float: left;">
					<div class="input">
						<div class="result">上課日期: <span id="classdate"></span></div>
						<button><i class="fa fa-calendar"></i></button>
					</div>
					<div class="calendar"></div>
				</div>
				<div class="date-picker-cancel" onclick="$('#classdate')[0].textContent = ''">
					&#10006;
				</div>
				<br>
			</div>
		</div>
		<div class="row">
			<div class="col-lg-2 col-md-1 col-sm-12"></div>
			<div class="col-lg-8 col-md-10 col-sm-12">
				<button class="btn btn-block btn-info" onclick="loadadverise()">
					搜尋 <i class="fa fa-search" aria-hidden="true"></i>
				</button>
			</div>
		</div>
		<div class="row">
			<div class="col-lg-2 col-md-1 col-sm-12"></div>
			<div class="col-lg-8 col-md-10 col-sm-12">
				<br>
				<table id="advertisetable">
					<thead>
						<tr>
							<th>老師</th>
							<th>電話</th>
							<th>地區</th>
							<th>簡介</th>
						</tr>
					</thead>
					<tbody id="teachers"></tbody>
				</table>
			</div>
		</div>
	</div>
{% endblock %}
{% block bcontent %}
<div id="adclass-frame" class="loginsignup-frame" hidden>
	<div class="loginsignup-frame-inside">
		<a id="closeloginframe" onclick="hide('adclass-frame');" style="">X</a>
		<br>
		<div class="frame-content" style="padding: 15px;padding-top: 0%;">
			<center id="adclasses" >
			</center>
		</div>
	</div>
</div>
{% endblock %}
{% block script %}
	<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
	<script src="/html/javascript/datepicker.js"></script>
	<script src="/html/javascript/taiwan_town.js"></script>
	<script src="/html/javascript/teacher/advertise.js" type="text/javascript" charset="utf-8"></script>
	<script>
		month_re = new RegExp("[0-9]+ 月")
		CLASS_TO = {
			"python_01": "Python 初級",
			"scratch_1": "Scratch 初級",
			"hourofcode": "Hour of Code",
			"teacher_1": "教師訓練",
		}

		advertise_format = `
		<tr id="teacher-{3}" onclick="showadclass('{3}')">
			<td>{0}</td> <!-- Name -->
			<td>{1}</td> <!-- Phone -->
			<td id="{3}-area"></td> <!-- City Town -->
			<td>{2}</td>
		</tr>
		`

		adclass_format = `
		<div class="top-bar-contain">
			<div class="top-bar">
				<label class="open flip-down">
					<span id="type">{0}</span><br />
					<span id="start">{1} 開課</span>

					<div id="detail"></div>
					<input type="checkbox" onclick="togglecontent(this)">
					<div class="content">
						<table>
							<tr>
								<td>{1} 開課</td>
							</tr>
							<tr>
								<td>{2}</td>
							</tr>
							<tr>
								<td>
									<br />
									上課日:
									<ul>
										{3}
									</ul>
								</td>
							</tr>
							<tr>
								<td>時間: {4} ~ {5}</td>
							</tr>
							<tr>
								<td>地址: {6}</td>
							</tr>
						</table>
					</div>
				</label>
			</div>
			<div class="fix-content"></div>
		</div>
		<br />
		`

		chinese_weekday = [
			"",
			"星期一",
			"星期二",
			"星期三",
			"星期四",
			"星期五",
			"星期六",
			"星期日",
		]

		CLASS_TO = {
			"python_01": "Python 初級",
			"scratch_1": "Scratch 初級",
			"hourofcode": "Hour of Code",
			"teacher_1": "教師訓練",
		}

		teachers = null;
		ads = {};
		function loadadverise() {
			c = $("#city")[0].value
			t = $("#towns")[0].value
			classtype = $("#classtype")[0].value;
			date = getdate("classdate")

			json = {};
			if (c !== "") {
				if (t != "") {
					t = city_towns[city].indexOf(t);
					json["town"] = t;
				}
				c = cities.indexOf(c);
				json["city"] = c;
			}
			if (classtype != "") {
				json["type"] = classtype;
			}
			if (date != "") {
				json["date"] = date;
			}

			jsonkeys = Object.keys(json)
				
			teachers_table = $("#teachers")[0]

			ads = {}
			teachers_table.innerHTML = "";
			exist_city_town = {}
			$.each(teachers, function (_, i) {
				if (jsonkeys.includes("type")) {
					if (json["type"] != i["type"]) {
						return true;
					}
				}
				if (jsonkeys.includes("city")) {
					if (json["city"] != i["city"]) {
						return true;
					}
				}
				if (jsonkeys.includes("town")) {
					if (json["town"] != i["town"]) {
						return true;
					}
				}
				if (jsonkeys.includes("date")) {
					date = json["date"].split("/")
					month = date[1]
					year = date[2]

					if (!i["date"].startsWith(year)) {
						return true;
					}

					m = month_re.exec(i["date"])[0]
					if (!m.startsWith(month)) {
						return true;
					}
				}

				if ($("#teacher-" + i["id"])[0] == undefined) {
					t = city_towns[cities[i["city"]]][i["town"]]
					c = cities[i["city"]]

					summary = i["summary"]
					if (summary == "" || summary == null) {
						summary = "沒有自我介紹"
					}
					teachers_table.innerHTML += format(advertise_format,
						i["name"],
						i["phone"],
						summary.replace(/\n/g, "<br>"),
						i["id"])

					ads[i["id"]] = []
				}

				if (exist_city_town[i["id"]] == undefined) {
					exist_city_town[i["id"]] = []
				}

				city_town_id = i["city"] + "-" + i["town"]
				if (!exist_city_town[i["id"]].includes(city_town_id)) {
					exist_city_town[i["id"]].push(city_town_id)
					t = city_towns[cities[i["city"]]][i["town"]]
					c = cities[i["city"]]
					$("#" + i["id"] + "-area")[0].innerHTML += c + " " + t + "<br>"
				}

				ads[i["id"]].push({
					"address": i["address"],
					"type": i["type"],
					"date": i["date"],
					"enddate": i["enddate"],
					"start_time": i["start_time"],
					"end_time": i["end_time"],
					"weekdays": i["weekdays"],
					"id": i["adclassid"],
					})
				types.add(i["type"])
			})
		}

		function showadclass(tid) {
			show("adclass-frame");

			$("#adclasses")[0].innerHTML = ""
			repeat = []
			$.each(ads[tid], function (_, ad) {
				if (repeat.includes(ad["id"])) {
					return true;
				}
				c_weekdays = ""
				$.each(ad["weekdays"], function (i) {
					c_weekdays += format(`<li>{0}</li>`, chinese_weekday[ad["weekdays"][i]])
				})

				enddate = "老師沒有指定結束日期"
				if (ad["enddate"] != null) {
					enddate = ad["enddate"] + " 結束"
				}

				$("#adclasses")[0].innerHTML += format(
					adclass_format,
					CLASS_TO[ad["type"]],
					ad["date"],
					enddate,
					c_weekdays,
					ad["start_time"],
					ad["end_time"],
					ad["address"]);
				repeat.push(ad["id"])
			})
			$.each($(".open input[type=checkbox]"), function (_, i) {
				togglecontent(i)
			})
		}

		function togglecontent(e) {
			if (e.checked) {
				$(e).parents(".top-bar").animate({
					borderBottomLeftRadius: "0px",
					borderBottomRightRadius: "0px",
				});
				$(e).parent().children("#detail")[0].innerHTML = `詳情 <i class="fa fa-caret-up" aria-hidden="true"></i>`
				
				$(e).parents(".top-bar-contain").children(".fix-content").css({
					height: "240px"
				})
			}
			else {
				$(e).parents(".top-bar").animate({
					borderBottomLeftRadius: "10px",
					borderBottomRightRadius: "10px",
				});
				$(e).parent().children("#detail")[0].innerHTML = `詳情 <i class="fa fa-caret-down" aria-hidden="true"></i>`
				
				
				$(e).parents(".top-bar-contain").children(".fix-content").css({
					height: "0px"
				})
			}
		}

		$(document).ready(function () {
			$.ajax({
				url: host + "adarea/",
				type: "GET",
				data: {},
				success: function (msg) {
					teachers = msg
					teachers_table = $("#teachers")[0]

					ads = {}
					teachers_table.innerHTML = "";

					types = new Set();
					cities_set = new Set();
					towns_set = {}
					exist_city_town = {}
					$.each(teachers, function (_, i) {
						if ($("#teacher-" + i["id"])[0] == undefined) {
							t = city_towns[cities[i["city"]]][i["town"]]
							c = cities[i["city"]]

							summary = i["summary"]
							if (summary == "" || summary == null) {
								summary = "沒有自我介紹"
							}
							teachers_table.innerHTML += format(advertise_format,
								i["name"],
								i["phone"],
								summary.replace(/\n/g, "<br>"),
								i["id"])

							ads[i["id"]] = []
						}
						cities_set.add(c)

						if (towns_set[c] == undefined) {
							towns_set[c] = []
						}
						if (!towns_set[c].includes(t)) {
							towns_set[c].push(t)
						}

						if (exist_city_town[i["id"]] == undefined) {
							exist_city_town[i["id"]] = []
						}

						city_town_id = i["city"] + "-" + i["town"]
						if (!exist_city_town[i["id"]].includes(city_town_id)) {
							exist_city_town[i["id"]].push(city_town_id)
							t = city_towns[cities[i["city"]]][i["town"]]
							c = cities[i["city"]]
							$("#" + i["id"] + "-area")[0].innerHTML += c + " " + t + "<br>"
						}

						ads[i["id"]].push({
							"address": i["address"],
							"type": i["type"],
							"date": i["date"],
							"enddate": i["enddate"],
							"start_time": i["start_time"],
							"end_time": i["end_time"],
							"weekdays": i["weekdays"],
							"id": i["adclassid"],
							})
						types.add(i["type"])
					})

					types_html = `<option value="" selected>所有的課程</option>`
					$.each(Array.from(types), function (_, type) {
						types_html += format(`<option value="{0}">{1}</option>`,
							type,
							CLASS_TO[type])
					})
					$("#classtype").html(types_html)

					cities_html = `<option value="" selected>全臺</option>`
					$.each(Array.from(cities_set), function (_, city_chose) {
						cities_html += format(`<option value="{0}">{0}</option>`,
							city_chose)
					})
					$("#city").html(cities_html)

					$.each(teachers, function (_, i) {
						c = cities[i["city"]]
						t = i["town"]
						t = city_towns[c][t]
						index = towns_set[c].indexOf(t)
						i["town"] = index
					})

					city_towns = towns_set
				}
			});

			date = new Date();
			m = date.getMonth() + 1
			d = date.getDate()
			if (m < 10) {
				m = "0" + m
			}
			if (d < 10) {
				d = "0" + d
			}
			d = date.getFullYear() + "/" + m + "/" + d
			$("#classdate").html(d)
		})
	</script>
{% endblock %}