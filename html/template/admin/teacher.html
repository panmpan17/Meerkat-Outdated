{% extends "base.html" %}
{% block title %}Admin 老師管理{% endblock %}
{% block css %}
<link rel="stylesheet" href="/html/css/editor.css">
<link rel="stylesheet" href="/html/css/checklist.css">
<style>
	.preview a {
		color:orange;
		text-decoration:none;
	}

	table {
		font-family: arial, sans-serif;
		border-collapse: collapse;
		width: 100%;
	}

	.table td,
	.table th {
		border: 1px solid #dddddd;
		text-align: left;
		padding: 8px;
		font-size: 20px;
	}

	.table tr {
		background-color: white;
	}

	.table tr.i:nth-child(even) {
		background-color: #F39C12;
	}
	.table tr.i:nth-child(odd) {
		background-color: #F1C40F;
	}

	i.fa-minus,
	i.fa-plus {
		cursor: pointer;
	}

	td> ul {
		margin: 2px;
		list-style: none;
	}

	td> ul> li:before {
		content:"#";
		color: #66d;
	}

	td> ul> li {
		/*display:inline;*/
		padding-right: 15px;
	}

	#sidebtn1 {
		float: right;
		font-size: 16px;
		width: 30px;
		height: 90px;
		background: #063044;
		color: white;
		word-spacing: 30px;
		text-align: center;
		cursor: pointer;
	}

	#sidebtn1:hover {
		background: white;
		color: #063044;
	}

	#sidebtn2 {
		margin-top: 95px;
		margin-right: -30px;
		float: right;
		font-size: 16px;
		width: 30px;
		height: 90px;
		background: #063044;
		color: white;
		word-spacing: 30px;
		text-align: center;
		cursor: pointer;
	}

	#sidebtn2:hover {
		background: white;
		color: #063044;
	}
</style>
{% endblock %}
{% block content %}
	<br><br>
	<a href="/admin/" style="padding-left: 14%"><button id="submit">< 回去</button></a>
	<br><br>
	<div class="container text-center">
		<input type="text" name="userid" placeholder="帳號">
		<br><br>
		<input type="text" name="password" placeholder="密碼">
		<br><br>
		<input type="text" name="name" placeholder="名字">
		<br><br>
		<input type="text" name="phone" placeholder="電話">
		<br><br>
		<dl class="check-list-right" id="classlist">
			<dt>教學課程權限</dt>
		</dl>
		<div id="signup-errormsg" class="login-errorms">
		</div>
		<button id="submit" onclick="signup()">註冊</button>
		<br><br><br>
		<table class="table">
			<thead>
				<tr>
					<th>Id</th>
					<th>帳號</th>
					<th>名字</th>
					<th>電話</th>
					<th></th>
				</tr>
			</thead>
			<tbody id="teachers">
			</tbody>
		</table>
	</div>
	<br><br><br><br><br>
{% endblock %}
{% block bcontent %}
<div id="change-frame" class="loginsignup-frame" hidden>
	<div class="loginsignup-frame-inside">
		<a id="closeloginframe" onclick="hide('change-frame');" style="">X</a>
		<div id="sidebtn1" onclick="hide('ad-setting');show('info-setting')">資訊設定</div>
		<div id="sidebtn2" onclick="hide('info-setting');show('ad-setting');loadadarea(teacher['id']);loadadclass(teacher['id'])">廣告設定</div>
		<br>
		<div id="info-setting" class="frame-content" style="padding: 15px;padding-top: 0px">
			<h3>資訊設定</h3><br>
			<input id="change-teacher-id" hidden  type="text">
			<input id="change-userid" placeholder="帳號"  type="text" style="width: 45%">
			<input id="change-password" placeholder="密碼"  type="text" style="width: 45%">
			<br>
			<span class="hint">* 密碼如果不改就請留空</span>
			<br>
			<input id="change-name" placeholder="名字"  type="text" style="width: 45%">
			<input id="change-phone" placeholder="電話"  type="text" style="width: 45%">
			<br><br>
			<textarea id="change-summary" class="form-control" cols="30" rows="10"></textarea>
			<br><br>
			地區: <input id="area-num" type="number" max="99" min="0" style="width: 50px">
			整縣市: <input id="city-num" type="number" max="99" min="0" style="width: 50px">
			<br><br>
			<dl class="check-list-right" id="change_classlist">
				<dt>教學課程權限</dt>
			</dl>
			<button class="btn" onclick="change_teacher()">更改</button>
		</div>
		<div id="ad-setting" class="frame-content" style="padding: 15px;padding-top: 0px" hidden>
			<h3>廣告設定</h3><br>
			<select class="form-control" id="city" onchange="changecity()">
				<option value="臺北市">臺北市</option>
				<option value="新北市">新北市</option>
				<option value="桃園市">桃園市</option>
				<option value="臺中市">臺中市</option>
				<option value="臺南市">臺南市</option>
				<option value="高雄市">高雄市</option>
				<option value="基隆市">基隆市</option>
				<option value="新竹市">新竹市</option>
				<option value="嘉義市">嘉義市</option>
				<option value="新竹縣">新竹縣</option>
				<option value="苗栗縣">苗栗縣</option>
				<option value="彰化縣">彰化縣</option>
				<option value="南投縣">南投縣</option>
				<option value="雲林縣">雲林縣</option>
				<option value="嘉義縣">嘉義縣</option>
				<option value="屏東縣">屏東縣</option>
				<option value="宜蘭縣">宜蘭縣</option>
				<option value="花蓮縣">花蓮縣</option>
				<option value="臺東縣">臺東縣</option>
				<option value="澎湖縣">澎湖縣</option>
				<option value="金門縣">金門縣</option>
				<option value="連江縣">連江縣</option>
			</select>
			<br>
			<select id="towns" class="form-control">
				<option value="中正區">中正區</option>
				<option value="大同區">大同區</option>
				<option value="中山區">中山區</option>
				<option value="松山區">松山區</option>
				<option value="大安區">大安區</option>
				<option value="萬華區">萬華區</option>
				<option value="信義區">信義區</option>
				<option value="士林區">士林區</option>
				<option value="北投區">北投區</option>
				<option value="內湖區">內湖區</option>
				<option value="南港區">南港區</option>
				<option value="文山區">文山區</option>
			</select>
			<br>
			<button type="button" class="btn btn-info btn-block" onclick="newarea()">
				新增地區
			</button>
			<br><br>
			<table class="table">
				<thead>
					<tr>
						<th>縣市</th>
						<th>鄉鎮市區</th>
						<th></th>
					</tr>
				</thead>
				<tbody id="tadarea"></tbody>
			</table><br>
			<table class="table">
				<thead>
					<tr>
						<th>課程種類</th>
						<th>開課日期</th>
						<th>結束日期</th>
						<th>上課日</th>
						<th>上課時間</th>
						<th>下課時間</th>
						<th>地址</th>
					</tr>
				</thead>
				<tbody id="tadclass"></tbody>
			</table>
		</div>
	</div>
</div>
{% endblock %}
{% block script %}
<script src="/html/js/taiwan_town.js"></script>
<script>
	teacher_format = `\
	<tr class="i">
		<td>{0}</td>
		<td>{1}{4}</td>
		<td>{2}</td>
		<td>{3}</td>
		<td>
			<span class="hover" style="color:red" onclick="delete_teacher({0})">
				<i class="fa fa-times" aria-hidden="true"></i>
			</span><br>
			<span class="hover" onclick="show_change_teacher({0})">
				<i class="fa fa-pencil" aria-hidden="true"></i>
			</span>
		</td>
	</tr>`

	classs_format = `\
	<dd>
		<input name="{2}class_permission" type="checkbox" id="{2}cid-{0}" value="{1}">
		<label for="{2}cid-{0}">{1}</label>
	</dd>
	`

	adarea_format = `
	<tr>
	<td>{0}</td>
	<td>{1}</td>
	<td class="b-close" onclick="deletearea('{2}')"><i class="fa fa-times"></i></td>
	</tr>
	`

	adclass_format = `
	<tr>
		<td>{0}</td>
		<td>{1}</td>
		<td>{2}</td>
		<td>{3}</td>
		<td>{4}</td>
		<td>{5}</td>
		<td>{6}</td>
		<td class="b-close" onclick="deleteadclass('{7}')"><i class="fa fa-times"></i></td>
	</tr>
	`

	chinese_weekday = [
		"",
		"星期一",
		"星期二",
		"星期三",
		"星期四",
		"星期五",
		"星期六",
		"星期日",
	]

	CLASS_TO = {
		"python_01": "Python 初級",
		"scratch_1": "Scratch 初級",
		"hourofcode": "Hour of Code",
		"teacher_1": "教師訓練",
	}

	teachers_table = $("#teachers")[0]

	function signup() {
		errormsg = $("#signup-errormsg")[0]

		userid = $("[name=userid]")[0].value;
		password = $("[name=password]")[0].value;
		name = $("[name=name]")[0].value;
		phone = $("[name=phone]")[0].value;

		checked_list = [];
		c = $("[name=class_permission]")
		for (i=0;i<c.length;i++) {
			if (c[i].checked) {
				checked_list.push(c[i].value);
			}
		}

		if (!(userid && password && name && phone)) {
			errormsg.innerHTML = "請不要留空白";
			return
		}

		if (checked_list.length == 0) {
			errormsg.innerHTML = "課程權限至少多於一個";
			return
		}

		password = sha256(password);

		json = {
			"key": getCookie("key"),
			"userid": userid,
			"password": password,
			"name": name,
			"phone": phone,
			"class_permission": checked_list,
			}
		$.ajax({
			url: host + "teacher/",
			type: "POST",
			dataType: "json",
			data: JSON.stringify(json),
			contentType: "application/json; charset=utf-8",
			success: function (msg) {
				location.reload()
			}
		})
	}

	function load_teachers() {
		$.ajax({
			url: host + "teacher/",
			type: "GET",
			data: {"key": getCookie("key")},
			success: function (msg) {
				teachers_table.innerHTML = "";
				teachers = {}
				$.each(msg["teachers"], function (_, i) {
					teachers[i["id"]] = i
				})

				$.each(teachers, function(_, i) {
					disabled = ""
					if (i["disabled"]) {
						disabled = "disabled"
					}

					p = "<ul>"
					permissions = i["class_permission"]
					for (e=0;e<permissions.length;e++) {
						p += "<li>" + permissions[e] + "</li>"
					}
					p += "</ul>"

					user = format(teacher_format,
						i["id"],
						i["userid"],
						i["name"],
						i["phone"],
						p);

					teachers_table.innerHTML += user
				})
			}
		})
	}

	function load_class() {
		$.ajax(host + "classes/id").success(function (msg) {
			listcount = 1
			$.each(msg["classes_id"], function (_, i) {
				$("#classlist")[0].innerHTML += format(classs_format,
					listcount,
					i,
					"")
				$("#change_classlist")[0].innerHTML += format(classs_format,
					listcount,
					i,
					"change_")
				listcount ++
			})
		})
	}

	function delete_teacher(tid) {
		c = prompt("你確定要刪除這個問題?\n如果是的話請輸入: "+ tid)
		if (c != tid) {
			alert("輸入失敗")
			return ;
		}
		url = window.location.origin + "/rest/1/teacher/?tid={0}&key={1}"
		$.ajax({
			url: format(url, tid, getCookie("key")),
			type: 'DELETE',
			success: function(msg) {
				load_teachers();
			}
		});
	}

	function show_change_teacher(tid) {
		teacher = teachers[tid]
		$("#change-teacher-id")[0].value = tid
		$("#change-userid")[0].value = teacher["userid"]
		$("#change-password")[0].value = ""
		$("#change-name")[0].value = teacher["name"]
		$("#change-phone")[0].value = teacher["phone"]
		$("#change-summary")[0].value = teacher["summary"]
		$("#area-num")[0].value = 5 + teacher["ext_area"]
		$("#city-num")[0].value = teacher["whole_city"]

		if (teacher["class_permission"].includes("scratch_1")) {
			$("[name=change_class_permission][value=scratch_1]")[0].checked = true
		}
		if (teacher["class_permission"].includes("teacher_1")) {
			$("[name=change_class_permission][value=teacher_1]")[0].checked = true
		}
		if (teacher["class_permission"].includes("python_01")) {
			$("[name=change_class_permission][value=python_01]")[0].checked = true
		}
		show("change-frame");
	}

	function change_teacher() {
		tid = $("#change-teacher-id")[0].value
		userid = $("#change-userid")[0].value
		password = $("#change-password")[0].value
		name = $("#change-name")[0].value
		phone = $("#change-phone")[0].value
		summary = $("#change-summary")[0].value
		ext_area = $("#area-num")[0].value - 5
		whole_city = $("#city-num")[0].value

		checked_list = [];
		c = $("[name=change_class_permission]")
		for (i=0;i<c.length;i++) {
			if (c[i].checked) {
				checked_list.push(c[i].value);
			}
		}

		json = {
			"key": getCookie("key"),
			"tid": tid,
			"userid": userid,
			"name": name,
			"phone": phone,
			"class_permission": checked_list,
			"ext_area": ext_area,
			"whole_city": whole_city,
			"summary": summary,
			}

		if (password != "") {
			c = confirm("更改教師密碼?")
			if (!c) {
				return
			}
			json["password"] = sha256(password)
		}

		$.ajax({
			url: host + "teacher/",
			type: "PUT",
			dataType: "json",
			data: JSON.stringify(json),
			contentType: "application/json; charset=utf-8",
			success: function (msg) {
				hide("change-frame")
				load_teachers();
			},
			error: function (error) {
				console.log(error)
			}
		})
	}

	function loadadarea(tid) {
		$.ajax({
			url: host + "adarea/",
			type: "GET",
			data: {
				"teacher": true,
				"tid": tid,
				"key": getCookie("key")},
			success: function (msg) {
				$("#tadarea")[0].innerHTML = "";

				if (msg["adareas"] == undefined) {
					return ;
				}

				advertise_num = msg["adareas"].length
				adareas = msg["adareas"]
				$.each(msg["adareas"], function (_, i) {
					city = cities[i["city"]]
					town = city_towns[city][i["town"]]

					$("#tadarea")[0].innerHTML += format(
						adarea_format,
						city,
						town,
						i["id"]);
				})
			}
		})
	}

	function loadadclass(tid) {
		$.ajax({
			url: host + "adclass/",
			type: "GET",
			data: {
				"teacher": true,
				"tid": tid,
				"key": getCookie("key")},
			success: function (msg) {
				$("#tadclass")[0].innerHTML = "";

				$.each(msg["adclasses"], function (_, i) {
					c_weekdays = []
					$.each(i["weekdays"], function (e) {
						c_weekdays.push(
							chinese_weekday[
								e
								])
					})

					enddate = ""
					if (i["enddate"]) {
						enddate = i["enddate"]
					}

					$("#tadclass")[0].innerHTML += format(
						adclass_format,
						CLASS_TO[i["type"]],
						i["date"],
						enddate,
						c_weekdays,
						i["start_time"],
						i["end_time"],
						i["address"],
						i["id"]);
				})
			}
		})
	}

	function deletearea(aid) {
		json = {
			"tid": teacher["id"],
			"key": getCookie("key"),
			"aid": aid}
		$.ajax({
			url: host + "adarea?" + $.param(json),
			type: "DELETE",
			success: function(result) {
				loadadarea(teacher["id"]);
			}
		});
	}

	function deleteadclass (aid) {
		c = confirm("你確定要刪除這個招生文?")
		if (!c) {
			return;
		}
		json = {
			"tid": teacher["id"],
			"key": getCookie("key"),
			"aid": aid}
		$.ajax({
			url: host + "adclass?" + $.param(json),
			type: "DELETE",
			success: function(result) {
				loadadclass(teacher["id"]);
			}
		});
	}

	function newarea () {
		if (advertise_num >= (teacher["ext_area"] + 5)) {
			alert("達到上限")
			return;
		}

		city = $("#city")[0].value;
		town = $("#towns")[0].value;

		town = city_towns[city].indexOf(town);
		city = cities.indexOf(city);

		passed = true;
		$.each(adareas, function (_, i) {
			if (i["city"] == city && i["town"] == town) {
				passed = false;
				return false;
			}
		})

		if (!passed) {
			alert("這區域重複了");
			return;
		}

		json = {
			"key": getCookie("key"),
			"tid": teacher["id"],
			"t_area": teacher["ext_area"],
			"city": city,
			"town": town,
			}
		$.ajax({
			url: host + "adarea/",
			type: "POST",
			dataType: "json",
			data: JSON.stringify(json),
			contentType: "application/json; charset=utf-8",
			success: function (msg) {
				loadadarea(teacher["id"]);
			}
		})
	}

	load_class();
	load_teachers();
</script>
{% endblock %}