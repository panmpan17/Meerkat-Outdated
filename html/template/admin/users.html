{% extends "base.html" %}
{% block title %}Admin 使用者管理{% endblock %}
{% block css %}
<style>
	table {
		font-family: arial, sans-serif;
		border-collapse: collapse;
		width: auto;
	}

	td {
		min-width: 100px;
		height: 40px;
	}

	#userstable td,
	#userstable th {
		border: 1px solid #dddddd;
		text-align: left;
		padding: 8px;
		font-size: 18px;
	}

	#userstable tr {
		background-color: white;
	}

	#userstable tr.i:nth-child(even) {
		background-color: #F39C12;
	}
	#userstable tr.i:nth-child(odd) {
		background-color: #F1C40F;
	}

	div#search-bar {
		position: absolute;
		text-align: center;
		top: 107px;
		left: calc(10% + 80px);
		width: 500px;
		height: 50px;
		transition-duration: 0.5s;
	}


	.toggle-button {
		max-width: 200px;
		position: relative;
		display: inline-block;
		color: black;
		margin-left: -15px;
	}
	.toggle-button label {
		margin-top: -2px;
		display: inline-block;
		cursor: pointer;
		text-align: left;
	}
	.toggle-button input {display: none}
	.toggle-button__icon {
		cursor: pointer;
		pointer-events: none;
	}
	.toggle-button__icon:before, .toggle-button__icon:after {
		content: "";
		position: absolute;
		top: 45%;
		left: 36%;
		transition: 0.2s ease-out;
	}

	.toggle-button--tuli label {
		line-height: 20px;
		text-indent: 30px;
		opacity: 0;
	}

	.toggle-button--tuli input:checked ~ .toggle-button__icon {background: #fff;}

	.toggle-button--tuli input:checked ~ .toggle-button__icon:before,
	.toggle-button--tuli input:checked ~ .toggle-button__icon:after {
		opacity: 1;
	}

	.toggle-button--tuli .toggle-button__icon {
		position: absolute;
		top: 0;
		left: 0;
		width: 20px;
		height: 20px;
		transition: all 0.2s;
		border: 2px solid #fff;
		border-radius: 1px;
		box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
		text-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
	}

	.toggle-button--tuli .toggle-button__icon:before,
	.toggle-button--tuli .toggle-button__icon:after {
		top: 5px;
		left: 4px;
		width: 12px;
		height: 2px;
		border-radius: 3px;
		background: #fff;
		box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
		top: 35%;
		background: #FF8300;
		opacity: 0;
		transform-origin: left center;
	}

	.toggle-button--tuli .toggle-button__icon:before {transform: translate(0, 0) rotate(45deg) scale(0.6, 1)}

	.toggle-button--tuli .toggle-button__icon:after {transform: translate(4px, 6px) rotate(-45deg)}

	.toggle-button--tuli input ~ .toggle-button__icon {
		box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
		text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
	}

	.toggle-button--tuli input:checked ~ label {color: #FF8300}
</style>
{% endblock %}
{% block content %}
<main>
	<div style="width: 90%;padding-left: 10%">
		<br><br>
		<a href="/admin/"><button class="btn btn-orange">< 回去</button></a>
		<br><br>
		<div id="search-bar">
			<input id="userid-field" class="form-control" type="text" width="400" placeholder="Search: ">
		</div>
		<table id="userstable">
			<thead>
				<tr>
					<th>Id</th>
					<th>帳號</th>
					<th>Email</th>
					<th>暱稱</th>
					<th>註冊日期</th>
				</tr>
			</thead>
			<tbody id="users"></tbody>
		</table> 
	</div>
	<br><br>
</main>
{% endblock %}
{% block bcontent %}
<div class="modal fade" id="userinfo-frame" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<a href="javascript:;"><span aria-hidden="true" style="color: black;">&Chi;</span></a>
				</button>
			</div>

			<div class="modal-body">
				<table id="userinfo2" style="padding-left: 5%">
					<tr>
						<td>Id</td>
						<td id="userinfo-id"></td>		
					</tr>
					<tr>
						<td>帳號</td>
						<td id="userinfo-userid"></td>		
					</tr>
					<tr>
						<td>積分</td>
						<td id="userinfo-point"></td>		
					</tr>
					<tr>
						<td>等級</td>
						<td id="userinfo-level"></td>		
					</tr>
					<tr>
						<td>暱稱</td>
						<td id="userinfo-nick"></td>		
					</tr>
					<tr>
						<td>Email</td>
						<td id="userinfo-email"></td>		
					</tr>
					<tr>
						<td>Email 認證</td>
						<td>
							<div class="container">
								<div class="toggle-button toggle-button--tuli">
									<input id="userinfo-active" type="checkbox">
									<label for="userinfo-active">.</label>
									<div class="toggle-button__icon"></div>
								</div>
							</div>
						</td>		
					</tr>
					<tr>
						<td>出生年</td>
						<td id="userinfo-birth"></td>		
					</tr>
					<tr>
						<td>註冊日期</td>
						<td id="userinfo-createat"></td>		
					</tr>
					<tr>
						<td>工作</td>
						<td id="userinfo-job"></td>		
					</tr>
					<tr>
						<td>管理者</td>
						<td id="userinfo-admin"></td>		
					</tr>
					<tr>
						<td>被封鎖</td>
						<td>
							<div class="container">
								<div class="toggle-button toggle-button--tuli">
									<input id="userinfo-disabled" type="checkbox">
									<label for="userinfo-disabled">.</label>
									<div class="toggle-button__icon"></div>
								</div>
							</div>
						</td>		
					</tr>
				</table>
			</div>
		</div>
	</div>
</div>
{% endblock %}
{% block script %}
<script>
var users = {};
var alphabet_index = {};

user_format = `\
<tr class="i" style="cursor:pointer" onclick="showdetail({0})">
	<td>{0}</td>
	<td><a onclick="showdetail({0})">{1}</a></td>
	<td>{2}</td>
	<td>{3}</td>
	<td>{4}</td>
</tr>\
`

function showdetail (uid) {
	$.ajax({
		url: host + "user/",
		type: "GET",
		data: {"key": getCookie("key"), "id": uid},
		success: function (msg) {
			console.log(msg)
			$("#userinfo-frame").modal("show");
			$("#userinfo-id")[0].innerHTML = msg["id"];
			$("#userinfo-userid")[0].innerHTML = msg["userid"];
			$("#userinfo-point")[0].innerHTML = msg["point"];
			$("#userinfo-nick")[0].innerHTML = msg["nickname"];
			$("#userinfo-email")[0].innerHTML = msg["email"];
			$("#userinfo-birth")[0].innerHTML = msg["birth_year"];
			$("#userinfo-createat")[0].innerHTML = msg["create_at"];
			$("#userinfo-job")[0].innerHTML = msg["job"];
			$("#userinfo-admin")[0].innerHTML = msg["admin"];
			$("#userinfo-active")[0].checked = msg["active"]
			$("#userinfo-disabled")[0].checked = msg["disabled"];

			$("#userinfo-level")[0].innerHTML = "一般";
			point = msg["point"];
			if (point > 200) {$("#userinfo-level")[0].innerHTML = "鑽石"}
			else if (point > 100) {$("#userinfo-level")[0].innerHTML = "白金"}
			else if (point > 20) {$("#userinfo-level")[0].innerHTML = "黃金"}
		}
	})
}

$("#userid-field").on("input change", function (e) {
	value = e.currentTarget.value
	first_chr = String(value[0])

	$("#users").html("")
	if (alphabet_index[first_chr] != undefined) {
		users_show = []
		$.each(alphabet_index[first_chr], function (_, i) {
			if (users[i]["userid"].startsWith(value)) {
				users_show.push(users[i])
			}
		})

		$.each(users_show, function (_, user) {
			$("#users")[0].innerHTML += format(
				user_format,
				user["id"],
				user["userid"],
				user["email"],
				user["nickname"],
				user["create_at"],
				)
		})
	}
})


$(document).ready(function () {
	$.ajax({
		url: host + "user/",
		type: "GET",
		data: {"key": getCookie("key")},
		success: function (msg) {
			$.each(msg, function (_, i) {
				users[i["id"]] = i

				first_chr = String(i["userid"][0])
				if (alphabet_index[first_chr] == undefined) {
					alphabet_index[first_chr] = []
				}
				alphabet_index[first_chr].push(i["id"])
			})
		}
	})
})
</script>
{% endblock %}